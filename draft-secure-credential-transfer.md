---
title: "Secure Credential Transfer"
abbrev: "Secure Credential Transfer"
docname: draft-securecredential-transfer-latest
category: std

ipr: trust200902
area: TODO
workgroup: TODO Working Group
keyword: Internet-Draft

stand_alone: yes
smart_quotes: no
pi: [toc, sortrefs, symrefs]

author:
 -
    name: Dmitry Vinokurov
    organization: Apple Inc
    email: dvinokurov@apple.com
 -
    name: B. Chester
    organization: Apple Inc
    email: bchester@add_email_here.apple.com
 -
    name: Matthias Lerch
    organization: Apple Inc
    email: mlerch@add_email_here.apple.com

normative:

informative:


--- abstract

This document describes a mechanism to transfer digital credentials securely between two devices
Secure credentials may represent a digital key to a hotel room, a digital key to a door lock in a house 
or a digital key to a car. Devices that share credentials may belong to the same or two different platforms (e.g. iOS and Android).
Secure transfer may include one or more write and read operations.
Credentials transfer needs to be performed securely due to the sensitive nature of the information.

--- middle

# Introduction

Today, there is no standard way of transferring digital credentials securely between two devices 
belonging to the same platform or two different platforms. This document proposes a solution to this problem 
by introducing a Relay server which allows devices to exchange encrypted Provisioning Information securely.
The Relay server solves this problem by creating and managing temporary mailbox storage.

Each mailbox can be referenced by devices from a unique mailbox identifier in a URL.
The URL pointing to encrypted Provisioning Information is to be passed between devices directly 
over various channels (e.g. SMS, email, messaging applications).
The exchange of the URL is outside of the scope of this document.

This document describes a Hypertext (HTTP) Application Programming Interface (API) that allows 
Sender and Receiver devices to interact with a Relay server in order to perform secure credential transfer.


# Terminology

{::boilerplate bcp14-tagged}

- Relay Server - Web application exposing Secure Credential Transfer API to remote devices. It serves to securily transfer Provisioning Information between two remote devices.

- Sender device - a remote device initiating a transfer of Provisioning Information to another remote device (Receiver) so that Receiver can provision these credentials.

- Receiver device - a remote device that receives Provisioning Information from Sender and uses it to provision Credentials Information to an application running on it.

- Provisioning Partner - Third party Partner that owns, manages, accepts and revokes Credential Information on a remote device (Sender or Receiver).

- Provisioning Information - a set of data fields, allowing a device to receive Credential Information from Provisioning Partner and install it locally. The entire content of Provisioning Information is encrypted by Sender or Receiver device. Therefore, it is not visible to Relay Server.

- Provisioning Information - a set of data fields allowing a device to receive Credential Information from Provisioning Partner and install it locally. The entire content of Provisioning info is encrypted be Sender or Receiver device; therefore, is not visible to Relay Server

- Credential Information - a set of data fields used to provision an access credential on the receiver's device.

- Transaction Information - information data structure generated by Receiver device required to start provisioning in the stateful flow. It includes cryptographic keys generated by Receiver device. Sender device needs to approve (sign) Transaction Information before Receiver can start provisioning. Exact content of Transaction Information is specific for each Provisioning Partner and out of scope of this document.

- Secret - a symmetric encryption key shared by a pair of a Sender and a Receiver devices, used to encrypt Provisioning Information stored on a Relay server. Secret stays the same for the entire credential transfer flow (one Secret per complete transfer). All information stored on Relay server is always encrypted using the Secret. In Stateful flow all information exchanged by Sender and Receiver devices throug Relay server is encrypted with the same Secret. Thus, effectively, Secret has a one-to-one relation with the mailbox.

- Device Claim - a unique token allowing caller to read from /write to data the mailbox. Exactly one sender device and one receiver device should be able to read from/write secure payload to the mailbox. Sender device provides a deviceClaim in order to create a mailbox or update mailbox data and Relay server binds this Sender's Device Claim to the mailbox. When the receiver device first reads data from the mailbox it presents its Device Claim to the Relay Server, which binds the mailbox to the given Receiver device. Thus both Sender and Receiver devices are bound to the mailbox (allowed to read from/write to it). Only Sender/Receiver devices that can present valid Device Claims are allowed to send subsequent read/write/update/delete calls to the mailbox. The value shall be a UUID {{!RFC4122}}.
 
- Notification Token - a short or long-lived unique token stored by the Sender or Receiver device in a mailbox on the Relay server, which allows Relay server to send a push notification message to the Sender or Receiver device, informing them on data update in the mailbox.


# Credential transfer workflows

We define two flows for credential transfer: 1. Stateless (Relay server facilitates a single credential data transfer: Sender -> Relay -> Receiver) and 2. Stateful (Relay facilitates additional datat transfers - there are 3 data exchanges in this flow to prepare credential data for provisioning by Receiver). The details are provided below.

## Stateless workflow

Stateless process starts with a Sender device composing a set of Provisioning Information, encrypting it with a Secret (symmetric data encryption key) and storing encrypted Provisioning Information on a Relay server in a mailbox. A unique mailbox identifier is generated by a Sender device as UUID that conforms to RFC 4122 version 4, created using good source of entropy (peferrably hardware-based entropy). Sender device generates a unique token - a Sender Device Claim - and stores it to the mailbox. Device Claim allows the Sender device presenting it to read and write data to/from the mailbox, thus binding it to the mailbox.

Sender device sends mailboxIdentifier to the Relay server as a part of CreateMailbox request.
Once mailbox is created, it has limited time to live. When expired, mailbox shall be deleted - refer to DeleteMailbox endpoint. Default expiration period has to be configured on the Relay server.

Relay server builds a unique URL link to a mailbox (for example, “http://relayserver.com/mailbox/1234567890”) and returns it to the Sender device, which sends the link directly to the Receiver device over communication channel (e.g. SMS, email, iMessage).
In addition to that, Sender device passes the Secret to the Receiver device either through the same channel (in the same message as the URL) or over a different channel.

Receiver device, having obtained both the URL link and the Secret,  generates a unique token - Receiver Device Claim - and passes it to the Relay server in order to reads the encrypted Provisioning Information from the mailbox. 

Relay server now binds a given pair of Sender a Receiver devices to the mailbox by provided Sender and Receiver Device Claims. Only bound devices are allowed to read or write data to the mailbox or to delete the mailbox.

Receiver device, having read the encrypted Provisioning Information from the Relay mailbox, decrypts it with the Secret received  from the Sender and starts credential provisioning process on the device. Once the Receiver device has successfully provisioned credentials, it deletes the mailbox by sending a DeleteMailbox call to the Relay server.

~~~
                      Sender              Relay                          Receiver
                        |                   |                               |
    Create and encrypt  |                   |                               |
    Provisioning Info   |——---------------->|                               |
                        |    CreateMailbox  |                               |
                        |<------------------|                               |
                        |URL link to mailbox|                               |
    Send URL link       |                   |                               |
    and Secret          |-------------------------------------------------->|
                        |                   | ReadSecureContent FromMailbox |
                        |                   |<------------------------------|
                        |                   |                               | Decrypt Provisioning Info with Secret
                        |                   |                               |
                        |                   |                               | Provision credentials
~~~
{: #stateless-flow-image title="Sample flow of stateless process"}

## Stateful workflow

Stateful process includes additional steps to exchange the Provisioning Information, resulting in three data exchanges between Sender and Receiver. 

The process starts with a Sender device building and encrypting Provisioning Information, storing it on a Relay server in a unique mailbox. A unique mailbox identifier is generated by the Sender device as UUID that conforms to RFC 4122 version 4, created from random data with good source of entropy (peferrably hardware-based entropy).

In addition to encrypted Provisioning Information, Sender stores a Sender Notification Token in the mailbox, which allows Relay server to send a notification message to the Sender device. Sender device generates a unique token - a Sender Device Claim - and stores it to the mailbox. Device Claim allows the Sender device presenting it to read and write data to/from the mailbox, thus binding it to the mailbox.

Sender device sends mailboxIdentifier to the Relay server as a part of CreateMailbox request.
Once mailbox is created, it has limited time to live. When expired, mailbox shall be deleted - refer to DeleteMailbox endpoint. Default expiration period has to be configured on the Relay server.

Relay server builds a unique URL link to a mailbox (for example, “http://relayserver.com/mailbox/1234567890”) and returns it to the Sender device, which sends the link directly to the Receiver device over communication channel (e.g. SMS, email, iMessage).
In addition to the URL link, Sender device passes a Secret (e.g. symmetric encryption key) to the Receiver device either through the same channel (in the same message as the URL) or over a different channel.

Receiver device, having obtained both the URL link and the Secret,  generates a unique token - Receiver Device Claim - and passes it to the Relay server in order to read the encrypted Provisioning Information from the mailbox. 

Relay server now binds a given pair of Sender a Receiver devices to the mailbox by provided Sender and Receiver Device Claims. Only bound devices are allowed to read or write data to the mailbox or to delete the mailbox.

Then the Receiver device, having downloaded the encrypted Provisioning Information from the mailbox by URL and decrypted it with the secret,  generates Transaction Information data structure and builds the following set of data fields: 

* Transaction Information
* Receiver Notification Token which allows the Relay server to send notification messages to the Receiver device. 

Receiver device adds the two fields above to the original Provisioning Information, encrypts them using the Secret received from Sender device, then stores all in the same mailbox on the Relay server.  Having received the encrypted Transaction Information, the Relay server sends a Notification to the Sender device using the Sender Notification Token. 

Sender device, having received the notification from the Relay server, reads secure content from the mailbox and decrypts all using the same Secret. Sender device generates a digital signature over the Receiver’s Transaction Information, appends it to the Provisioning Information and Receiver’s Transaction Information fields, encrypts all these fields using the Secret and stores all data in the mailbox on the Relay server.

Relay server, having stored the data above, sends a notification message to the Receiver device using Receiver Notification Token. Receiver device, having received the notification, reads the encrypted Provisioning Information, Receiver’s Transaction Information and Sender’s Signature over the Transaction Information, decrypts all three fields using the same Secret and uses this data to start credential provisioning on device. 

Once the Receiver device has successfully provisioned credentials, it deletes the mailbox by sending a DeleteMailbox call to the Relay server.
Sender device may terminate the secure credential transfer by deleting the mailbox it created at any time. Deletion of the mailbox on Relay server stops any on-going credential transfer process.

~~~
                     Sender                       Relay                     Receiver
                        |                            |                            |
    Create and encrypt  |    CreateMailbox           |                            |
    Provisioning Info   |--------------------------->|                            |
                        |    encrypted info          |                            |
                        |<---------------------------|                            |
                        |   URL link to mailbox      |                            |
                        |                            |                            |
    Send URL link       |-------------------------------------------------------->|
    and Secret          |                            |ReadSecureContentFromMailbox|
                        |                            |                            |
                        |                            |<---------------------------| Decrypt w Secret,
                        |                            |    encrypted info	  |
                        |                            |    UpdateMailbox           | TxInfo=Generate TxInfo,
                        |                            |<---------------------------| encrypted info = 
                        |ReadSecureContentFromMailbox|       encrypted info       | encrypt(ProvInfo,TxInfo)
                        |                            |  (ProvInfo + TxInfo)       | with Secret
    Sign TxInfo         |--------------------------->|                            |
    with OwnerKey,      |	encrypted info       |                            |
    encrypted info =    |                            |                            |
    encrypt(ProvInfo,   |     UpdateMailbox          |                            |
    TxInfo,Signature)   |—-----------—-------------->|ReadSecureContentFromMailbox|
    with Secret         |    encrypted info          |                            |
                        |                            |<---------------------------| Decrypt(ProvInfo,TxInfo,
                        |                            | 	encrypted info            | Signature)	
                        |                            |                            | Provision credentials
~~~
{: #stateful-flow-image title="Sample flow of stateful process"}

# API connection details

The Relay server API endpoint MUST be accessed over HTTP using an https URI {{!RFC2818}} and SHOULD use the default https port. 
Request and response bodies shall be formatted as either JSON or HTML (based on the API endpoint). The communication protocol used for all interfaces shall be HTTPs.
All Strings shall be UTF-8 encoded (Unicode Normalization Form C (NFC)).
An API version shall be included in the URI for all interfaces. The version at the time of this document's latest update is v1. The version shall be incremented by 1 for major API changes or backward incompatible iterations on existing APIs.

# HTTP Headers: X-Correlation-ID

All requests to and from Relay server will have an HTTP header "X-Correlation-ID". The corresponding response to the API will have the same HTTP header "X-Correlation-ID", which should echo the value in the request header. This is used to identify the request associated to the response for a particular API request and response pair. The value shall be a UUID of length 36 containing hyphens.


# HTTP access methods

## CreateMailbox

An application running on a remote device can invoke this API on Relay Server to create a mailbox and store secure data content to it (encrypted data specific to a provisioning partner).

### Endpoint

POST  /{version}/mailbox

### Request Parameters:

Path parameters

- version (String, Required) - the version of the API. At the time of writing this document, “v1”.

Header parameters

- deviceAttestation (String, Optional) - optional remote device-specific attestation data.
- deviceClaim (String, UUID, Required) - Device Claim (refer to Terminology).

### Consumes

This API call consumes the following media types via the Content-Type request header: `application/json`

### Request body 

Request body is a complex structure, including the following fields:

- mailboxIdentifier (String, Required) - a unique identifier of the mailbox to be created.
- payload (String, Required) - for the purposes of Secure Credential Transfer API, this is a JSON metadata blob, describing Provisioning Information specific to Credential Provider. The following 2 key-value pairs are built into payload field:
    1. "type": "AES128" (refer to Encryption Format section).
    2. "data": valur of ciphertext.
- displayInformation (String, Required) - for the purposes of the Secure Credential Transfer API, this is a JSON data blob. It allows an application running on a receiving device to build a visual representation of the credential to show to user. Specific to Credential Provider.
- notificationToken (Object, Optional) - optional notification token used to notify an appropriate remote device that the mailbox data has been updated. Data structure includes the following:
    1. type (String, Required) - notification token name. Used to define which Push Notification System to be used to notify appropriate remote device of a mailbox data update. (E.g. "com.apple.apns" for APNS)
    2. tokenData (String, Required) - notification token data (Hex or Base64 encoded based on the concrete implementation) - application-specific - refer to appropriate Push Notification System specification.
- mailboxConfiguration (Object, Optional) - optional mailbox configuration, defines access rights to the mailbox, mailbox expirationTime. Required at the time of the mailbox creation. Data structure includes the following:
    1. accessRights (String, Optional) - optional access rights to the mailbox for Sender and  Receiver devices. Default access to the mailbox is Read and Delete. 
Value is defined as a combination of the following values: "R" - for read access, "W" - for write access, "D" - for delete access. Example" "RD" - allows to read from the mailbox and delete it.
    2. expirationTime (String, optional) - Mailbox expiration time (UTC). E.g. "2021-07-22T13:14:15Z". Mailbox has a limited time to live. Once expired, it shall be deleted - refer to DeleteMailbox endpoint. Default expiration period has to be configured on the Relay server.

~~~
{
   "notificationToken": {
        "name":"com.apple.apns",
        "tokenData":"APNS1234...QW"
    }
}
~~~
{: #apple-push-token title="Apple Push Token Example"}

~~~
{    "mailboxIdentifier" : "12345678-9...A-BCD",
    "displayInformation" : {
        "title" : "Hotel Pass",
        "description" : "Some Hotel Pass",
        "imageURL" : "https://hotel.com/sharingImage" 
    },
    "payload" : "FDEC...987654321",
    "notificationToken" : {
        "type" : "com.apple.apns",
        "tokenData" : “APNS...1234"
    },
    "mailboxConfiguration" : {
        "accessRights" : "RWD",
        "expirationTime" : "2021-01-01 01:01:01”
    }
}
~~~
{: #create-mailbox-request title="Create Mailbox Request Example"}

### Responses

`200`
Status: “200” (OK)

ResponseBody:
- urlLink (String, Required) - a full URL link to the mailbox including fully qualified domain name and mailbox dientifier.

~~~
{
    "urlLink":"relay.com/mailbox/12345678-9...A-BCD"
}
~~~
{: #create-mailbox-response title="Create Mailbox Response Example"}

`400`
Bad Request - invalid request has been passed (can not parse or required fields missing).

`401`
Unauthorized - calling device is not authorized to create a mailbox. E.g. a device presented the incorrect deviceClaim or mailbox with the provided mailboxIdentifier already exists.


## UpdateMailbox

An application running on a remote device can invoke this API on Relay Server to update secure data content in an existing mailbox (encrypted data specific to a Provisioning Partner).

### Endpoint

PUT  /{version}/mailbox/{mailboxIdentifier}

### Request Parameters

Path parameters:

- version (String, Required) - the version of the API. At the time of writing this document, “v1”.
- mailboxIdentifier(String, Required) - Sender device-defined unique identifier for the given mailbox. The value shall be a UUID of length 36 containing hyphens.

Header parameters:

- deviceAttestation (String, Optional) - optional remote device-specific attestation data.
- deviceClaim (String, UUID, Required) - Device Claim (refer to Terminology).

### Consumes

This API call consumes the following media types via the Content-Type request header: `application/json`

### Request body 

Request body is a complex structure, including the following fields:

- payload (String, Required) - for the purposes of Secure Credential Transfer API, this is a JSON metadata blob, describing Provisioning Information specific to Credential Provider.
- displayInformation (String, Required) - for the purposes of the Secure Credential Transfer API, this is a JSON data blob. It allows an application running on a receiving device to build a visual representation of the credential to show to user. Specific to Credential Provider.
- notificationToken (Object, Optional) - Optional notification token used to notify an appropriate remote device that the mailbox data has been updated. Data structure includes the following:
	- type (String, Required) - notification token name. Used to define which Push Notification System to be used to notify appropriate remote device of a mailbox data update. (E.g. "com.apple.apns" for APNS)
	- tokenData (String, Required) - notification token data (Hex or Base64 encoded based on the concrete implementation) - application-specific - refer to appropriate Push Notification System specification

~~~
{
    "displayInformation" : {
        "title" : "Hotel Pass",
        "description" : "Some Hotel Pass",
        "imageURL" : "https://hotel.com/sharingImage"
    },
    "payload" : "FDEC...987654321",
    "notificationToken":{
        "type" : "com.apple.apns",
        "tokenData" : “APNS...1234"
    }
}
~~~
{: #update-mailbox-request title="Update Mailbox Request Example"}

### Responses

`200 `
Status: “200” (OK)

`400`
Bad Request - invalid request has been passed (can not parse or required fields missing).

`401`
Unauthorized - calling device is not authorized to create a mailbox. E.g. a device presented the incorrect deviceClaim.

`404`
Not Found - mailbox with provided mailboxIdentifier not found.


## DeleteMailbox

An application running on a remote device can invoke this API on Relay Server to close the existing mailbox after it served its purpose. Receiver or Sender device needs to present a deviceClaim in order to close the mailbox. Upon closure, the mailbox shall still respond to GET operations, returning the OpenGraph displayInformation.

### Endpoint

DELETE /{version}/mailbox/{mailboxIdentifier}

### Request Parameters

Path parameters:

- version (String, Required) - the version of the API. At the time of writing this document, “v1”.
- mailboxIdentifier(String, Required) - Sender device-defined unique identifier for the given mailbox. The value shall be a UUID of length 36 containing hyphens.

Header parameters:

- deviceAttestation (String, Optional) - optional remote device-specific attestation data.
- deviceClaim (String, UUID, Required) - Device Claim (refer to Terminology).

### Responses

`200`
Status: “200” (OK)

`401`
Unauthorized - calling device is not authorized to create a mailbox. E.g. a device presented the incorrect deviceClaim.

`404`
Not Found - mailbox with provided mailboxIdentifier not found.


## ReadDisplayInformationFromMailbox

An application running on a remote device can invoke this API on Relay Server to to retrieve public display information content from a mailbox. Application-specific (e.g. OpenGraph, JSON).

### Endpoint

GET /{version}/mailbox/{mailboxIdentifier}

### Request Parameters

Path parameters:

- version (String, Required)- the version of the API. At the time of writing this document, “v1”.
- mailboxIdentifier(String, Required) - Sender device-defined unique identifier for the given mailbox. The value shall be a UUID of length 36 containing hyphens.

### Responses

`200`
Status: “200” (OK)

ResponseBody :

- displayInformation (String, Required) - application-specific (e.g. OpenGraph, JSON) visual representation of digital credential.

~~~
    "<html prefix="og: https://ogp.me/ns#">
     <head>
     <title>Hotel Pass</title>
     <meta property="og:title" content="Hotel Pass" />
     <meta property="og:type" content="image/jpeg" />
     <meta property="og:description" content="Some Hotel Pass" />
     <meta property="og:url" content="share://" />
     <meta property="og:image" content="https://website.com/photos/photo.jpg" />
     <meta property="og:image:width" content="612" />
     <meta property="og:image:height" content="408" /></head>
     </html>"
~~~
{: #read-display-information-response title="Read Display Information Response Example"}

`401`
Unauthorized - calling device is not authorized to create a mailbox. E.g. a device presented the incorrect deviceClaim.

`404`
Not Found - mailbox with provided mailboxIdentifier not found.


## ReadSecureContentFromMailbox

An application running on a remote device can invoke this API on Relay Server to to retrieve secure payload content from a mailbox (encrypted data specific to a Provisioning Information Provider).

### Endpoint

POST /{version}/mailbox/{mailboxIdentifier}

### Request Parameters

Path parameters:

- version (String, Required) - the version of the API. At the time of writing this document, “v1”.
- mailboxIdentifier(String, Required) - Sender device-defined unique identifier for the given mailbox. The value shall be a UUID of length 36 containing hyphens.

Header parameters:

- deviceAttestation (String, Optional) - optional remote device-specific attestation data.
- deviceClaim (String, UUID, Required) - Device Claim (refer to Terminology).

### Responses

`200`
Status: “200” (OK)

ResponseBody : 

- payload (String, Required) - for the purposes of Secure Credential Transfer API, this is a JSON metadata blob, describing Provisioning Information specific to Credential Provider.
- displayInformation (String, Required) - for the purposes of the Secure Credential Transfer API, this is a JSON data blob. It allows an application running on a receiving device to build a visual representation of the credential to show to user. Specific to Credential Provider.

~~~
{
    “displayInformation" : {
        "title" : "Hotel Pass",
        "description" : "Some Hotel Pass",
        "imageURL" : "https://hotel.com/sharingImage"
    },
    "payload" : “{'type':'AES128','data': 'FDEC...987654321'}"
}
~~~
{: #read-secure-content-response title="Read Secure Content Response Example"}

`401`
Unauthorized - calling device is not authorized to create a mailbox. E.g. a device presented the incorrect deviceClaim.

`404`
Not Found - mailbox with provided mailboxIdentifier not found.



# Security Considerations

This section discusses security considerations for the protocol.


# IANA Considerations

This document has no IANA actions.


--- back

# Acknowledgments

TODO acknowledge.
